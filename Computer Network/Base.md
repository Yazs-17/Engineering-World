
## 导言

以`IPV4`为例,讨论前提假设：
IP：`192.168.1.1`, 子网掩码：`255.255.255.0`

用网线连接两台电脑，不能直接互通，配置IP地址，若前三位一样，可直接通信
（PC1 发送数据包给PC2，PC2收到数据包，PC1收到返回包）

三台电脑（PC1，PC2，PC3，同一网段），则所有电脑需要连接交换机，
PC1发送数据包给PC2，先到交换机，交换机不知道发送给谁，分发给所有电脑，
PC3收到丢弃，PC2收到发送返回包告诉PC1收到了

四台电脑，有几台不在同一网段，则使用路由器，让不同网段进行通信
![[attachments/Pasted image 20251101172749.png]]
如上图，PC2想要传一个数据包给PC4，不在同一网段，
先给交换机，交换机发给PC1，PC3和路由器，PC1、PC3直接丢弃，路由器收到把数据包给PC4，然后发送返回包原路返回

> PS: 像192.168.0.0 - 192.168.255.255这种C类私有地址，自己使用随便配



## 1. TCP/IP 网络模型有那几层

**应用层**

最上层，专注为用户提供应用功能，如HTTP，FTP，Telnet，DNS，SMTP等
应用层是工作在操作系统中的用户态，传输层及以下则工作在内核态



**传输层**

只负责数据的发送和接收，不负责数据在设备之间的传输
两大传输协议：TCP，UDP
端口

**网络层**

实际传输功能
网络层协议：IP协议（寻址->导航，路由->操作方向盘）

**网络接口层**

在IP头部加上MAC头部，封装成数据帧，发送到网络上
负责在以太网、WIFI这样的底层网络上发送原始数据包
工作在网卡层次，使用MAC地址标识网络设备

## 2. 键入网址到网页显示，期间发生了什么

##### **HTTP**

解析URL，浏览器确定Web服务器和文件名，并由此生成HTTP请求消息

##### **DNS**

通过DNS服务器或浏览器缓存或操作系统缓存或者hosts文件等获取IP

##### **协议栈**

获取IP后，把HTTP的传输工作交给操作系统的协议栈（收发数据、切片、发送数据）

> **协议栈**补充： 
>
> 浏览器（通过调用Socket库） ->  **协议栈**\[包含TCP、UDP、IP (包含ICMP、ARP，传送网络包，确定路由)\]  -> 网卡驱动程序（控制网卡硬件） -> 物理硬件网卡（实际收发操作）
> 
> 协议栈分为两部分：
> 1. 上一块为负责收发数据的TCP和UDP协议（接受应用层的委托执行收发数据的操作）
> 2. 下一块是IP协议控制网络包收发操作
>    
>   在互联网上传数据时，数据会被切分成一块块的网络包，而将网络包发送给对方的操作就是用**IP**负责的
>   
>   **IP**中包括`ICMP`(用于告知网络包传送过程中的错误以及各种控制信息) 和 `ARP` (用于根据IP地址查询相应的以太网MAC地址) 协议
>   
>   IP下面的==网卡驱动程序==负责控制网卡硬件，而最下面的**网卡**则负责完成实际的收发操作，也就是对网线中的信号执行发送和接收操作
>
##### 详细协议介绍
###### 1. TCP
面向连接，双方维护连接状态（==By状态位==），
   - HTTP是基于TCP协议传输的
	   - 源端口号（16位） ｜ 目标端口号（16位）
	   - 序号（32位）-为解决包乱序问题
	   - 确认序列（32位）- 确认发出收到，若没收到需重发，解决丢包问题
	   - 状态位，例`SYN`发起连接，`ACK`是回复，`RST`重新连接，`FIN`结束连接等
	   - 窗口大小，流量管理，声明缓存大小==标识处理能力==，别发送太快撑死我，太慢饿死我
	   - 拥塞处理，控制自己发送的速度
   - HTTP传输数据之前，首先需要TCP建立连接（三次握手）
	   - 这个所谓的「连接」，只是双方计算机里维护一个状态机
		   - 1. 客户端和服务端都处于`CLOSED`状态。先是服务端主动监听某个端口，处于`LISTEN`状态。
		   - 2. 然后客户端主动发起连接`SYN`，之后处于`SYN-SENT`状态。
		   - 3. 服务端收到发起的连接，返回`SYN`，并且`ACK`客户端的`SYN`，之后处于`SYN-RCVD`状态
		   - 4. 客户端收到`SYN`和`ACK`之后，发送对`SYN`确认的`ACK`，之后处于`ESTABLISHED`状态，因为它一发一收成功了
		   - 5. 服务端收到`ACK`之后，处于`ESTABLISHED`状态，因为它一发一收成功了
	   - 三次握手目的是==保证双方都有发送和接收的能力==
	   - 查看TCP连接状态 >`netstat -napt`;
	   - TCP分割数据 > 若HTTP 请求消息较长，超过了`MSS`的长度，这时TCP就需要把HTTP的数据拆解成一块块的数据发送，而不是一次性发送所有数据
	   - 报头/起始帧分解符 - MAC头部 - IP头部 - TCP头部 - 数据 - FCS
	    <----网络包传输方向
	    - MTU = IP头部+TCP头部+数据(最大长度)，MSS=数据(最大长度)
	    - MTU：一个网络包的最大长度，以太网中一般为1500字节
	    - MSS：除去IP和TCP头部之后，一个网络包所能容纳的TCP数据的最大长度
		    - 数据都会以MSS的长度为单位进行拆分，拆封出来的每一块数据都会被放进单独的网络包中，也就是在每个被拆分的数据加上TCP头信息，然后交给IP模块发送信息
   - TCP协议里有两个端口，一个是浏览器监听端口（通常是随机生成的），一个是Web服务器监听的端口（HTTP for 80， HTTPS for 443）
   - 双方建立连接之后，TCP报文中的数据部分就是存放HTTP头部+数据，组装好TCP报文之后，就需交给下面的网络层处理, 至此，网络包的报文如下图：
     ![[attachments/Pasted image 20251025094342.png]]
###### 2. IP
TCP模块在执行连接、收发、断开等各阶段操作时，都需要委托IP模块将数据封装成网络包发送给通信对象
- IP协议里需要有==源地址IP==和==目标地址IP==
- 因为HTTP是经过TCP传输的，所以在IP包头的协议号，要填写为十六进制，表示协议为TCP
- 条目、子网掩码、与运算、默认网关（0.0.0.0）
- 报文结构从上到下依次是：
  IP头部，远程定位能力
  TCP头部
  HTTP报文
   
######  3. MAC
两点传输，在IP头部上方再加上MAC头部
MAC头部是以太网使用的头部，它包含了接收方和发送方的MAC地址等信息（还有 ==协议类型==，一般都是0800-IP协议， 0806-ARP协议）
- 广播查询，ARP缓存查询结果


##### **出口：网卡** - 端口具有MAC地址
将网络包复制到网卡缓冲区，开头加报头和起始帧分界符，末尾加上用以检测错误的帧校验序列（FCS）
==将数字信号转换为电信号，便于在网线上传输==

将校验包的MAC是不是发给自己

##### **送别者：交换机**-端口不具有MAC地址

- 工作在MAC层，基于以太网设计，二层网络设备
- 目的将网络包原样转发到目的地
- 校验FCS，没问题就放到缓冲区
- **交换机的MAC地址表**用以查找MAC地址，把信号传到对应的端口

不校验包的MAC


##### **出境大门：路由器**

基于IP设计，三层网路设备，

路由器的各个端口都有MAC地址和IP地址


##### **互相扒皮：服务器与客户端**

四次挥手 TODO


## 3. HTTP篇

> 超文本传输协议

#### 1. 状态码
200 
204 （No Body）
206 （断点续传）

301 （永久重定向）
302 （临时重定向）
304 （资源已缓存）

400 （笼统错误码）
403 （服务器禁止）
404

500 （笼统错误码，服务器处理错误）
502 （Bad Gateway）
503 （服务器忙）

#### 2. HTTP 常见字段
**HOST字段**
客户端发送请求时，用来指定服务器的域名
**Content-Length字段**
服务器返回数据时，会有`Content-Length`字段，表明本次回应的数据长度
**粘包问题**
原因：TCP不关心应用层数据边界，接收方应用程序读取速度不足


#### 3. 安全和幂等
「安全」指请求方法不会**破坏**服务器上的资源
「幂等」指执行多次相同的操作之后结果相同
则GET安全且幂等，POST不安全也不幂等

##### 3. HTTP 缓存技术
**强制缓存**
只要浏览器判断缓存没有过期，则直接使用浏览器本地缓存，决定是否使用缓存的主动性在于浏览器这边。

**协商缓存**
304状态码



#### 4. HTTP 特性

HTTP/1.1， HTTPS，HTTP/2， HTTP/3


#### 5. HTTP RSA握手解析
#### 6. HTTP ECDHE握手

#### 7. RPC协议
手写一个RPC栈

#### 8. WebSocket

## 4. TCP篇

##### 核心组成

1. 源端口号，目标端口号
2. 序列号
3. 确认应答号
4. 控制位...

##### 如何唯一确定一个TCP连接？
TCP四元组（源地址、源端口、目的地址、目的端口）

##### TCP 和 UDP 可以使用同一个端口。

#####   为什么每次建立 TCP 连接时，初始化的序列号都要求不一样呢？

1. 为了防止历史报文被下一个相同四元组的连接接收（主要方面）；
2. 为了安全性，防止黑客伪装的相同序列号的TCP报文被对方接收

##### 既然IP层会分片，为什么TCP层还需要MSS呢？
- MTU
- MSS


##### TCP 半连接队列和全连接队列
- 半连接队列，也称 SYN 队列
- 全连接队列，也称accept队列
（详见本章状态码介绍）

##### 如何优化TCP？
可以与HTTP/3 反串（


##### 

TODO


### TCP Keepalive和HTTP Keep-Alive一样吗
当然不一样。名字都不一样（


TCP 重传，滑动窗口，流量控制，拥塞控制

TCP半连接队列，全连接队列

TCP面向字节流协议

初始化序列号

SYN 等报文体系

三次握手，四次挥手

TLS和TCP
。。。



## 5. IP 篇

ping， ipv6，ipv4，dns，arp，dhcp，nat，icmp，igmp


and so on

道阻且长
